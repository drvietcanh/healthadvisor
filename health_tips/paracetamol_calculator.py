"""
Paracetamol Calculator
T√≠nh li·ªÅu paracetamol ƒë√∫ng theo c√¢n n·∫∑ng (kg)
An to√†n cho tr·∫ª em v√† ng∆∞·ªùi l·ªõn
"""

import streamlit as st


def calculate_paracetamol_dose(weight_kg: float, age_years: int = None) -> dict:
    """
    T√≠nh li·ªÅu paracetamol theo c√¢n n·∫∑ng
    
    Args:
        weight_kg: C√¢n n·∫∑ng (kg)
        age_years: Tu·ªïi (nƒÉm) - optional, ƒë·ªÉ ki·ªÉm tra an to√†n
    
    Returns:
        dict: {
            "dose_mg": li·ªÅu t√≠nh b·∫±ng mg,
            "syrup_ml": li·ªÅu siro (n·∫øu d√πng siro 160mg/5ml),
            "tablet_formulations": dict v·ªõi s·ªë vi√™n theo t·ª´ng h√†m l∆∞·ª£ng,
            "max_daily_mg": li·ªÅu t·ªëi ƒëa trong 24h,
            "frequency": kho·∫£ng c√°ch gi·ªØa c√°c l·∫ßn (gi·ªù),
            "safety_note": l∆∞u √Ω an to√†n
        }
    """
    if weight_kg <= 0:
        return None
    
    # Li·ªÅu paracetamol: 10-15mg/kg/l·∫ßn cho tr·∫ª em
    # Li·ªÅu ng∆∞·ªùi l·ªõn: 500-1000mg/l·∫ßn (t·ªëi ƒëa 4000mg/ng√†y)
    
    # Tr·∫ª em (< 12 tu·ªïi ho·∫∑c < 40kg)
    if age_years and age_years < 12 or weight_kg < 40:
        dose_per_kg = 15  # mg/kg - li·ªÅu an to√†n cho tr·∫ª
        dose_mg = round(weight_kg * dose_per_kg)
        
        # Kh√¥ng qu√° 1000mg/l·∫ßn cho tr·∫ª
        dose_mg = min(dose_mg, 1000)
        
        # Li·ªÅu t·ªëi ƒëa ng√†y: 60mg/kg (kh√¥ng qu√° 4000mg)
        max_daily_mg = min(int(weight_kg * 60), 4000)
        frequency_hours = 4  # C√°ch 4-6 gi·ªù
        safety_note = "Tr·∫ª em: C√°ch 4-6 gi·ªù/l·∫ßn, t·ªëi ƒëa 4 l·∫ßn/ng√†y"
    else:
        # Ng∆∞·ªùi l·ªõn (‚â• 12 tu·ªïi ho·∫∑c ‚â• 40kg)
        if weight_kg < 50:
            dose_mg = 500
        elif weight_kg < 70:
            dose_mg = 650
        else:
            dose_mg = 1000
        
        max_daily_mg = 4000  # T·ªëi ƒëa 4000mg/ng√†y cho ng∆∞·ªùi l·ªõn
        frequency_hours = 6  # C√°ch 6-8 gi·ªù
        safety_note = "Ng∆∞·ªùi l·ªõn: C√°ch 6-8 gi·ªù/l·∫ßn, t·ªëi ƒëa 4 l·∫ßn/ng√†y"
    
    # T√≠nh siro (160mg/5ml) - th∆∞·ªùng cho tr·∫ª em
    syrup_ml = None
    if weight_kg < 40:
        syrup_ml = round((dose_mg / 160) * 5, 1)
    
    # T√≠nh s·ªë vi√™n theo c√°c h√†m l∆∞·ª£ng ph·ªï bi·∫øn
    # C√°c h√†m l∆∞·ª£ng: 250mg, 500mg, 650mg
    tablet_formulations = {}
    
    # Vi√™n 250mg (th∆∞·ªùng cho tr·∫ª l·ªõn/thanh thi·∫øu ni√™n)
    tablets_250 = dose_mg / 250
    if tablets_250 == int(tablets_250):
        tablet_formulations["250mg"] = int(tablets_250)
    elif tablets_250 < 1:
        tablet_formulations["250mg"] = "1 vi√™n (‚âà250mg, h∆°i thi·∫øu)"
    else:
        tablet_formulations["250mg"] = f"{int(tablets_250)}+ vi√™n (kh√¥ng khuy·∫øn ngh·ªã - d√πng lo·∫°i kh√°c)"
    
    # Vi√™n 500mg (ph·ªï bi·∫øn nh·∫•t)
    tablets_500 = dose_mg / 500
    if tablets_500 == int(tablets_500):
        tablet_formulations["500mg"] = int(tablets_500)
    elif tablets_500 < 1:
        tablet_formulations["500mg"] = "1 vi√™n (‚âà500mg)"
    else:
        # L√†m tr√≤n l√™n/xu·ªëng g·∫ßn nh·∫•t
        if tablets_500 <= 1.5:
            tablet_formulations["500mg"] = "1 vi√™n (‚âà500mg, h∆°i thi·∫øu)"
        else:
            tablet_formulations["500mg"] = int(round(tablets_500))
    
    # Vi√™n 650mg (Efferalgan)
    tablets_650 = dose_mg / 650
    if tablets_650 == int(tablets_650):
        tablet_formulations["650mg"] = int(tablets_650)
    elif tablets_650 < 1:
        tablet_formulations["650mg"] = "1 vi√™n (‚âà650mg, h∆°i d∆∞)"
    else:
        if tablets_650 <= 1.3:
            tablet_formulations["650mg"] = "1 vi√™n (‚âà650mg)"
        else:
            tablet_formulations["650mg"] = f"{int(round(tablets_650))} vi√™n (‚âà{int(round(tablets_650)) * 650}mg)"
    
    # Vi√™n 1000mg (ng∆∞·ªùi l·ªõn)
    if dose_mg >= 1000:
        tablets_1000 = dose_mg / 1000
        if tablets_1000 == int(tablets_1000):
            tablet_formulations["1000mg"] = int(tablets_1000)
        else:
            tablet_formulations["1000mg"] = int(round(tablets_1000))
    
    return {
        "dose_mg": dose_mg,
        "syrup_ml": syrup_ml,
        "tablet_formulations": tablet_formulations,
        "max_daily_mg": max_daily_mg,
        "frequency_hours": frequency_hours,
        "safety_note": safety_note,
        "is_child": weight_kg < 40 or (age_years and age_years < 12)
    }


def render_paracetamol_calculator():
    """Hi·ªÉn th·ªã m√°y t√≠nh paracetamol"""
    st.subheader("üíä M√°y t√≠nh li·ªÅu Paracetamol")
    
    st.info("""
    **üìå Paracetamol l√† g√¨?**
    
    Paracetamol (c√≤n g·ªçi l√† Acetaminophen) l√† thu·ªëc h·∫° s·ªët, gi·∫£m ƒëau an to√†n nh·∫•t.
    - ‚úÖ D√πng ƒë∆∞·ª£c cho tr·∫ª em, ph·ª• n·ªØ c√≥ thai
    - ‚úÖ Kh√¥ng g√¢y vi√™m d·∫° d√†y (kh√°c v·ªõi Aspirin, Ibuprofen)
    - ‚ö†Ô∏è Nh∆∞ng QU√Å LI·ªÄU s·∫Ω G√ÇY ƒê·ªòC GAN - r·∫•t nguy hi·ªÉm!
    """)
    
    col1, col2 = st.columns(2)
    
    with col1:
        weight_kg = st.number_input(
            "‚öñÔ∏è C√¢n n·∫∑ng (kg)",
            min_value=5.0,
            max_value=150.0,
            value=50.0,
            step=0.5,
            help="Nh·∫≠p c√¢n n·∫∑ng ch√≠nh x√°c"
        )
    
    with col2:
        age_years = st.number_input(
            "üéÇ Tu·ªïi (nƒÉm) - t√πy ch·ªçn",
            min_value=0,
            max_value=120,
            value=None,
            step=1,
            help="Nh·∫≠p tu·ªïi ƒë·ªÉ t√≠nh ch√≠nh x√°c h∆°n (t√πy ch·ªçn)"
        )
    
    # T√≠nh to√°n
    if st.button("üßÆ T√≠nh li·ªÅu", type="primary", use_container_width=True):
        if weight_kg <= 0:
            st.error("‚ö†Ô∏è Vui l√≤ng nh·∫≠p c√¢n n·∫∑ng h·ª£p l·ªá!")
            return
        
        result = calculate_paracetamol_dose(weight_kg, age_years)
        
        if not result:
            st.error("‚ùå Kh√¥ng th·ªÉ t√≠nh to√°n. Vui l√≤ng ki·ªÉm tra l·∫°i!")
            return
        
        # Hi·ªÉn th·ªã k·∫øt qu·∫£
        st.success("‚úÖ **K·∫øt qu·∫£ t√≠nh to√°n:**")
        
        col_a, col_b = st.columns(2)
        
        with col_a:
            st.metric("üíä Li·ªÅu m·ªói l·∫ßn", f"{result['dose_mg']} mg")
            st.metric("‚è∞ C√°ch nhau", f"{result['frequency_hours']} gi·ªù")
        
        with col_b:
            st.metric("üìä T·ªëi ƒëa/ng√†y", f"{result['max_daily_mg']} mg")
            st.metric("üîÑ S·ªë l·∫ßn/ng√†y", f"T·ªëi ƒëa {result['max_daily_mg'] // result['dose_mg']} l·∫ßn")
        
        st.divider()
        
        # C√°ch d√πng c·ª• th·ªÉ
        st.markdown("### üìã C√°ch d√πng c·ª• th·ªÉ theo t·ª´ng lo·∫°i:")
        
        # Siro cho tr·∫ª em
        if result['is_child'] and result['syrup_ml']:
            st.markdown(f"""
            **üçº Siro Paracetamol (160mg/5ml) - D√†nh cho tr·∫ª nh·ªè:**
            - M·ªói l·∫ßn: **{result['syrup_ml']} ml** (‚âà {result['dose_mg']}mg)
            - C√°ch {result['frequency_hours']}-6 gi·ªù/l·∫ßn
            - üí° D√πng ·ªëng ti√™m ƒë·ªãnh l∆∞·ª£ng (c√≥ s·∫µn trong h·ªôp) ho·∫∑c th√¨a ƒëo ƒë√∫ng ml
            - ‚ö†Ô∏è Kh√¥ng d√πng th√¨a ƒÉn c∆°m (sai li·ªÅu!)
            """)
        
        # Hi·ªÉn th·ªã c√°c lo·∫°i vi√™n
        st.markdown("**üíä Vi√™n Paracetamol (ng∆∞·ªùi l·ªõn & tr·∫ª l·ªõn):**")
        
        formulations = result['tablet_formulations']
        
        # Vi√™n 250mg
        if "250mg" in formulations:
            count = formulations["250mg"]
            if isinstance(count, int):
                st.markdown(f"""
                - **Vi√™n 250mg:** {count} vi√™n = {count * 250}mg
                  - VD: Panadol 250mg, Paracetamol 250mg (generic)
                """)
            else:
                st.markdown(f"""
                - **Vi√™n 250mg:** {count}
                """)
        
        # Vi√™n 500mg (ph·ªï bi·∫øn nh·∫•t)
        if "500mg" in formulations:
            count = formulations["500mg"]
            if isinstance(count, int):
                st.markdown(f"""
                - **Vi√™n 500mg:** ‚úÖ {count} vi√™n = {count * 500}mg (KHUY·∫æN NGH·ªä)
                  - VD: Panadol 500mg, Paracetamol 500mg (generic), Hapacol 500mg
                """)
            else:
                st.markdown(f"""
                - **Vi√™n 500mg:** {count}
                """)
        
        # Vi√™n 650mg
        if "650mg" in formulations:
            count = formulations["650mg"]
            if isinstance(count, int):
                total_mg = count * 650
                st.markdown(f"""
                - **Vi√™n 650mg (Efferalgan):** {count} vi√™n = {total_mg}mg
                  - üí° Efferalgan tan trong mi·ªáng, d·ªÖ u·ªëng
                """)
            else:
                st.markdown(f"""
                - **Vi√™n 650mg:** {count}
                """)
        
        # Vi√™n 1000mg
        if "1000mg" in formulations:
            count = formulations["1000mg"]
            if isinstance(count, int):
                st.markdown(f"""
                - **Vi√™n 1000mg:** {count} vi√™n = {count * 1000}mg
                  - VD: Panadol Extra, Paracetamol 1000mg (ng∆∞·ªùi l·ªõn n·∫∑ng c√¢n)
                """)
        
        st.markdown(f"""
        ‚è∞ **C√°ch nhau:** {result['frequency_hours']}-8 gi·ªù/l·∫ßn
        üìÖ **T·ªëi ƒëa:** {result['max_daily_mg']}mg trong 24 gi·ªù
        """)
        
        # C·∫£nh b√°o an to√†n
        st.error(f"""
        ‚ö†Ô∏è **C·∫¢NH B√ÅO ƒê·ªé - T·ªêI QUAN TR·ªåNG:**
        
        **üö´ TUY·ªÜT ƒê·ªêI KH√îNG u·ªëng Paracetamol sau khi u·ªëng r∆∞·ª£u bia!**
        
        - üç∫ **R∆∞·ª£u bia + Paracetamol = SUY GAN C·∫§P T√çNH, C√ì TH·ªÇ T·ª¨ VONG!**
        - ‚è∞ C√°ch √≠t nh·∫•t **8-12 gi·ªù** sau khi u·ªëng r∆∞·ª£u bia m·ªõi ƒë∆∞·ª£c d√πng paracetamol
        - üî• ƒêau ƒë·∫ßu do say r∆∞·ª£u? ‚Üí U·ªëng nhi·ªÅu n∆∞·ªõc, ngh·ªâ ng∆°i, KH√îNG u·ªëng paracetamol!
        - üíÄ **ƒê√¢y l√† nguy√™n nh√¢n h√†ng ƒë·∫ßu g√¢y suy gan do thu·ªëc t·∫°i VN!**
        
        **üìã C√°c l∆∞u √Ω kh√°c:**
        1. **{result['safety_note']}**
        2. **Kh√¥ng qu√° {result['max_daily_mg']} mg trong 24 gi·ªù**
        3. **Kh√¥ng t·ª± √Ω tƒÉng li·ªÅu** - Qu√° li·ªÅu g√¢y suy gan!
        4. N·∫øu s·ªët kh√¥ng gi·∫£m sau 2-3 ng√†y ‚Üí **ƒêi kh√°m b√°c sƒ©**
        5. Tr·∫ª em < 3 th√°ng tu·ªïi ‚Üí **H·ªèi b√°c sƒ© tr∆∞·ªõc khi d√πng**
        6. **ƒê√£ u·ªëng r∆∞·ª£u?** ‚Üí ƒê·ª£i √≠t nh·∫•t 8-12 gi·ªù, u·ªëng nhi·ªÅu n∆∞·ªõc, ngh·ªâ ng∆°i
        """)
        
        # B·∫£ng t√≥m t·∫Øt
        st.markdown("### üìä T√≥m t·∫Øt li·ªÅu d√πng:")
        
        if result['is_child']:
            tips = [
                f"üéØ **Li·ªÅu m·ªói l·∫ßn:** {result['dose_mg']}mg ({result['syrup_ml']}ml siro n·∫øu d√πng)",
                f"‚è∞ **C√°ch nhau:** {result['frequency_hours']}-6 gi·ªù",
                f"üìÖ **T·ªëi ƒëa/ng√†y:** {result['max_daily_mg']}mg (‚âà {result['max_daily_mg'] // result['dose_mg']} l·∫ßn)",
                "‚úÖ **An to√†n:** Kh√¥ng u·ªëng qu√° 4 l·∫ßn/ng√†y",
                "‚ö†Ô∏è **Tr√°nh:** Kh√¥ng d√πng c√πng l√∫c v·ªõi thu·ªëc kh√°c c√≥ paracetamol"
            ]
        else:
            tips = [
                f"üéØ **Li·ªÅu m·ªói l·∫ßn:** {result['dose_mg']}mg",
                f"‚è∞ **C√°ch nhau:** {result['frequency_hours']}-8 gi·ªù",
                f"üìÖ **T·ªëi ƒëa/ng√†y:** {result['max_daily_mg']}mg (4 l·∫ßn √ó 1000mg)",
                "‚úÖ **An to√†n:** C√°ch 6-8 gi·ªù/l·∫ßn, kh√¥ng qu√° 4 l·∫ßn/ng√†y",
                "‚ö†Ô∏è **Tr√°nh:** Kh√¥ng d√πng qu√° 4000mg/ng√†y, kh√¥ng u·ªëng r∆∞·ª£u khi d√πng"
            ]
        
        for tip in tips:
            st.markdown(f"- {tip}")


def get_paracetamol_guidelines() -> str:
    """Tr·∫£ v·ªÅ h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng paracetamol"""
    return """
## üìö H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Paracetamol ƒë√∫ng c√°ch

### ‚úÖ Khi n√†o d√πng Paracetamol?

Paracetamol d√πng ƒë·ªÉ:
- üî• **H·∫° s·ªët:** Khi nhi·ªát ƒë·ªô > 38.5¬∞C (ƒëo ·ªü n√°ch) ho·∫∑c khi s·ªët g√¢y kh√≥ ch·ªãu
- üò£ **Gi·∫£m ƒëau:** ƒêau ƒë·∫ßu, ƒëau rƒÉng, ƒëau c∆°, ƒëau nh·ª©c sau ti√™m vaccine

### ‚ùå Khi n√†o KH√îNG d√πng?

- ‚õî **Suy gan, vi√™m gan** (tuy·ªát ƒë·ªëi tr√°nh!)
- ‚õî **ƒê√£ u·ªëng r∆∞·ª£u bia trong 8-12 gi·ªù** ‚Üí TUY·ªÜT ƒê·ªêI TR√ÅNH!
- ‚õî ƒê√£ u·ªëng qu√° 4000mg trong 24h
- ‚õî ƒêang u·ªëng thu·ªëc kh√°c c√≥ ch·ª©a paracetamol (tr√°nh qu√° li·ªÅu)
- ‚õî D·ªã ·ª©ng v·ªõi paracetamol

### üö´ C·∫¢NH B√ÅO ƒê·ªé - Paracetamol + R∆∞·ª£u Bia:

**NGUY HI·ªÇM CH·∫æT NG∆Ø·ªúI!**

- üç∫ **R∆∞·ª£u bia l√†m gan kh√¥ng th·ªÉ chuy·ªÉn h√≥a paracetamol an to√†n**
- üíÄ **‚Üí T√≠ch t·ª• ƒë·ªôc t·ªë ‚Üí Suy gan c·∫•p t√≠nh ‚Üí T·ª≠ vong trong 48-72 gi·ªù**
- ‚è∞ **Quy t·∫Øc v√†ng:** Sau khi u·ªëng r∆∞·ª£u bia, ƒë·ª£i **√≠t nh·∫•t 8-12 gi·ªù** m·ªõi d√πng paracetamol
- üî• **ƒêau ƒë·∫ßu do say r∆∞·ª£u?** ‚Üí U·ªëng nhi·ªÅu n∆∞·ªõc, ngh·ªâ ng∆°i, KH√îNG d√πng paracetamol!

### üí° M·∫πo an to√†n:

1. **Ki·ªÉm tra th√†nh ph·∫ßn:** Nhi·ªÅu thu·ªëc c·∫£m c√∫m c√≥ ch·ª©a paracetamol
   - Panadol = Paracetamol
   - Efferalgan = Paracetamol 650mg
   - Tiffy, Decolgen = C√≥ paracetamol + c√°c ch·∫•t kh√°c
   - ‚Üí ƒê·ªçc k·ªπ nh√£n, tr√°nh u·ªëng c√πng l√∫c!

2. **C√°ch ƒëo siro cho tr·∫ª:**
   - ‚úÖ D√πng ·ªëng ti√™m ƒë·ªãnh l∆∞·ª£ng (c√≥ s·∫µn trong h·ªôp)
   - ‚úÖ ƒêo ƒë√∫ng ml, kh√¥ng d√πng th√¨a ƒÉn c∆°m
   - ‚úÖ Tr·∫ª kh√¥ng ch·ªãu u·ªëng? Pha lo√£ng v·ªõi ch√∫t n∆∞·ªõc

3. **D·∫•u hi·ªáu qu√° li·ªÅu (g·ªçi 115 ngay!):**
   - N√¥n m·ª≠a
   - ƒêau b·ª•ng v√πng gan (b√™n ph·∫£i)
   - V√†ng da, v√†ng m·∫Øt
   - Bu·ªìn ng·ªß b·∫•t th∆∞·ªùng

4. **N·∫øu s·ªët kh√¥ng h·∫° sau 2-3 ng√†y:**
   - ‚Üí ƒêi kh√°m b√°c sƒ© (c√≥ th·ªÉ l√† vi√™m nhi·ªÖm c·∫ßn kh√°ng sinh)
   - ‚Üí Kh√¥ng t·ª± √Ω tƒÉng li·ªÅu paracetamol

### üìä Li·ªÅu chu·∫©n theo c√¢n n·∫∑ng:

- **Tr·∫ª em:** 10-15mg/kg/l·∫ßn, c√°ch 4-6 gi·ªù
- **Ng∆∞·ªùi l·ªõn:** 500-1000mg/l·∫ßn, c√°ch 6-8 gi·ªù
- **T·ªëi ƒëa:** 60mg/kg/ng√†y (tr·∫ª) ho·∫∑c 4000mg/ng√†y (ng∆∞·ªùi l·ªõn)
"""

